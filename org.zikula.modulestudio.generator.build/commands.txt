# Commands for building a p2 site for the generator

# set path to target platform
setpref targetPlatformPath=${WORKSPACE}../../MOST-1_Prepare-1_Target_Platform/lastSuccessful/archive/targetPlatform

# materialise stuff by cquery/rmap
resolve --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" "scm/org.zikula.modulestudio.generator.build/most.cquery"

# clean the workspace
build --clean

# this first Java build will fail with compilation errors, since Xtend
# classes have not been compiled yet.  However, it will compile some
# Java classes so that we will be able to compile Xtend classes
build --continueonerror

# compile Xtend 2 classes
launch --stderr --stdout -l "org.zikula.modulestudio.generator/XtendCompiler.launch"
build --continueonerror
# run a Java build to compile the Java files generated by the Xtend compiler

# gather metrics on source code level
perform --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" "org.zikula.modulestudio.generator.build#metrics.prebuild"

# build workspace
build

# run tests and code coverage (buckminster emma --help)
#emma --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" --launch "org.zikula.modulestudio.generator.tests/AllTests.launch" --terseXML --flatXML --output "${WORKSPACE}output/test_results/junit/alltests.xml" --exec "${WORKSPACE}output/test_results/coverage/alltests.exec" --stderr --stdout

# build feature p2 repository
perform --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" "org.zikula.modulestudio.generator.build#site.p2"

# gather metrics on byte code level
perform --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" "org.zikula.modulestudio.generator.build#metrics.postbuild"

# move repository to /site.p2.artifact/
perform "org.zikula.modulestudio.generator.build#finish.repository"

# generate API documentation
perform --properties "refProduct/de.guite.modulestudio.build/buckminster.properties" "org.zikula.modulestudio.generator.build#create.documentation"
